# ExplanationAgent (Answer Explanation) Architecture

**File:** `backend/agents/explanation_agent.py`

---

## Purpose

The ExplanationAgent produces a **human‚Äëreadable rationale** for the answer generated by the LLM. It extracts the reasoning steps, cites source documents, and formats the explanation for display in the UI.

---

## High‚ÄëLevel ASCII Diagram

```
+-------------------+      +----------------------+      +-------------------+
|   Final Answer    | ---> |   ExplanationAgent   | ---> |   Explanation    |
+-------------------+      +----------------------+      +-------------------+
        |                         |                         |
        | 1. Identify cited docs | 2. Summarise reasoning |
        | 3. Format bullet list  | 4. Add source links    |
        v                         v                         v
+-------------------+      +----------------------+      +-------------------+
|   Source IDs      |      |   Reasoning Extractor|      |   Formatted Text |
+-------------------+      +----------------------+      +-------------------+
```

---

## Core Methods

```python
class ExplanationAgent:
    async def explain(self, answer: str, sources: List[Dict]) -> str:
        """Return a markdown‚Äëformatted explanation with citations."""
        reasoning = self._extract_reasoning(answer)
        citations = self._format_citations(sources)
        return f"**Answer:** {answer}\n\n**Reasoning:**\n{reasoning}\n\n**Sources:**\n{citations}"

    def _extract_reasoning(self, answer: str) -> str:
        """Parse the LLM's internal thinking steps (if provided via SSE)."""
        ...

    def _format_citations(self, sources: List[Dict]) -> str:
        """Create a markdown list of source links with titles and snippets."""
        lines = []
        for src in sources:
            lines.append(f"- [{src['title']}]({src['url']}) ‚Äì {src.get('snippet','')} ")
        return "\n".join(lines)
```

---

## Interaction with Other Components

- **Zeus** calls `ExplanationAgent.explain` after the answer is generated.
- **Themis** may provide confidence information that is included in the explanation.
- **Frontend** renders the markdown directly in the chat window.
- **MemoryManager** stores the explanation in session memory for later retrieval.

---

## Configuration (`config.yaml`)

```yaml
agents:
  explanation_agent:
    enabled: true
    include_thinking_steps: true   # Pull SSE thinking steps if available
    max_sources_display: 5
```

---

## Error Handling & Logging

- Logs each step with `loguru` (`üó£Ô∏è Explanation`).
- If source data is missing, the agent returns a fallback text stating "No source citations available."
- Exceptions are caught and a generic explanation is returned.

---

## Testing Strategy

1. **Unit Tests** for `_format_citations` with mock source dicts.
2. **Mock SSE** to verify `_extract_reasoning` captures thinking steps.
3. **Integration Test**: Full query flow, ensure the UI receives a markdown block with answer, reasoning, and source list.
4. **Performance**: Explanation generation ‚â§‚ÄØ200‚ÄØms.

---

*ExplanationAgent makes Vantage‚Äôs answers transparent, boosting trust by showing why and where the answer came from.*
